From 17baca469a221da6b8c1531d13cfd33cb6eceed3 Mon Sep 17 00:00:00 2001
From: Jimmy Jia <tesrin@gmail.com>
Date: Wed, 18 Apr 2018 23:28:35 -0400
Subject: [PATCH 3/6] Fix detection of annotated argument defaults

This improves E252 to allow default arguments like `_default(f=1)`.

Closes gh-753
---
 pycodestyle.py   | 12 ++++++------
 testsuite/E25.py |  3 +++
 2 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/pycodestyle.py b/pycodestyle.py
index dc86d30..f545cc0 100755
--- a/pycodestyle.py
+++ b/pycodestyle.py
@@ -937,17 +937,17 @@ def whitespace_around_named_parameter_equals(logical_line, tokens):
                 parens -= 1
             elif in_def and text == ':' and parens == 1:
                 annotated_func_arg = True
-            elif parens and text == ',' and parens == 1:
+            elif parens == 1 and text == ',':
                 annotated_func_arg = False
             elif parens and text == '=':
-                if not annotated_func_arg:
-                    no_space = True
-                    if start != prev_end:
-                        yield (prev_end, message)
-                else:
+                if annotated_func_arg and parens == 1:
                     require_space = True
                     if start == prev_end:
                         yield (prev_end, missing_message)
+                else:
+                    no_space = True
+                    if start != prev_end:
+                        yield (prev_end, message)
             if not parens:
                 annotated_func_arg = False
 
diff --git a/testsuite/E25.py b/testsuite/E25.py
index 55ed438..8898157 100644
--- a/testsuite/E25.py
+++ b/testsuite/E25.py
@@ -45,3 +45,6 @@ async  def add(a: int = 0, b: int = 0) -> int:
 #: E252:1:15 E252:1:16 E252:1:27 E252:1:36
 def add(a: int=0, b: int =0, c: int= 0) -> int:
     return a + b + c
+#: Okay
+def add(a: int = _default(name='f')):
+    return a
-- 
2.17.2 (Apple Git-113)

